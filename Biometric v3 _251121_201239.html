<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Biometric V3.1 [Responsive]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Black+Ops+One&display=swap');

        :root {
            --primary: #00ff41;
            --error: #ff0033;
            --bg: #0a0a0a;
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden;
            /* The Magic Fix for Mobile Browsers */
            width: 100vw;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
        }

        .mil-font { font-family: 'Black Ops One', cursive; }

        /* CRT Screen Effect Overlay */
        .crt-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* Responsive Video Layer */
        .viewport-layer {
            position: relative;
            flex: 1; /* Takes up all remaining space */
            width: 100%;
            overflow: hidden;
            background: #000;
        }

        video {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Fills screen on ALL devices */
            transform: scaleX(-1);
            opacity: 0.6;
        }

        canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* Responsive HUD */
        .hud-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20;
            padding: 20px;
        }

        .scanner-box {
            /* Responsive Size: 60% of the smallest screen dimension */
            width: 60vmin; 
            height: 60vmin;
            max-width: 500px;
            max-height: 500px;
            border: 1px solid rgba(0, 255, 65, 0.3);
            position: relative;
        }

        .scanner-bar {
            position: absolute;
            width: 100%;
            height: 4px;
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .hud-corner {
            position: absolute;
            width: 15%;
            height: 15%;
            border: 3px solid var(--primary);
            transition: all 0.3s;
        }

        /* Console Log Area */
        .console-area {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #333;
            height: 15vh; /* Responsive height */
            max-height: 120px;
            overflow-y: hidden;
            padding: 8px;
            font-size: 12px;
            z-index: 30;
            pointer-events: none;
        }

        /* Control Footer */
        .footer-controls {
            height: auto;
            min-height: 80px;
            background: #000;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
            padding: 10px;
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* iPhone Home Bar Safe */
            z-index: 60;
        }

        .btn-control {
            flex: 1;
            background: rgba(20, 20, 20, 1);
            border: 1px solid #444;
            color: #888;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 10px;
        }
        .btn-control:active { transform: scale(0.97); }
        .btn-control.active { border-color: var(--primary); color: var(--primary); background: rgba(0,255,65,0.1); }

        /* Fingerprint Styles */
        .finger-guide {
            width: 25vmin;
            height: 25vmin;
            border: 2px dashed #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10vmin;
            transition: all 0.3s;
        }
        .finger-guide.active { border-color: var(--primary); background: rgba(0,255,65,0.2); color: var(--primary); }

    </style>
</head>
<body>
    <div class="crt-overlay"></div>

    <div class="flex justify-between items-center p-3 md:p-4 border-b border-gray-800 bg-black/90 z-50 backdrop-blur">
        <div class="flex items-center gap-3">
            <i class="fas fa-biohazard text-2xl text-green-600 animate-pulse"></i>
            <div>
                <h1 class="mil-font text-xl md:text-2xl tracking-widest leading-none text-white">SECURE<span class="text-green-500">OS</span></h1>
                <div class="text-[10px] md:text-xs text-gray-500 tracking-[0.3em]">V3.1 UNIVERSAL</div>
            </div>
        </div>
        <div class="text-right hidden xs:block">
            <div id="clock" class="text-sm font-bold text-green-500">--:--</div>
            <div class="text-[10px] text-gray-500">ONLINE</div>
        </div>
    </div>

    <div class="viewport-layer">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>

        <div id="face-hud" class="hud-container hidden">
            <div class="scanner-box">
                <div class="hud-corner top-0 left-0 border-b-0 border-r-0"></div>
                <div class="hud-corner top-0 right-0 border-b-0 border-l-0"></div>
                <div class="hud-corner bottom-0 left-0 border-t-0 border-r-0"></div>
                <div class="hud-corner bottom-0 right-0 border-t-0 border-l-0"></div>
                <div class="scanner-bar"></div>
            </div>
            <div class="mt-4 bg-black/70 px-4 py-2 border border-green-900 text-green-400 font-mono text-sm md:text-base backdrop-blur">
                MATCH: <span id="match-score" class="text-white font-bold">0%</span>
            </div>
        </div>

        <div id="finger-hud" class="hud-container hidden bg-black/90">
            <div id="finger-guide" class="finger-guide mb-4">
                <i class="fas fa-fingerprint"></i>
            </div>
            <h2 class="mil-font text-2xl text-white mb-2">SENSOR ACTIVE</h2>
            <p class="text-center text-gray-400 text-sm max-w-xs">Cover REAR CAMERA completely</p>
            
            <div class="w-64 md:w-96 h-3 bg-gray-800 mt-6 rounded-full overflow-hidden border border-gray-700">
                <div id="finger-bar" class="h-full bg-green-500 w-0 transition-all duration-100"></div>
            </div>
        </div>

        <div class="console-area">
            <div id="console" class="flex flex-col-reverse h-full w-full"></div>
        </div>
    </div>

    <div class="footer-controls">
        <button id="btn-face" class="btn-control" disabled>
            <i class="fas fa-user-shield text-xl mb-1"></i>
            <span class="text-xs font-bold tracking-widest">FACE ID</span>
        </button>
        <button id="btn-finger" class="btn-control" disabled>
            <i class="fas fa-fingerprint text-xl mb-1"></i>
            <span class="text-xs font-bold tracking-widest">TOUCH ID</span>
        </button>
    </div>

    <img id="ref-img" src="1000069322.jpg" class="hidden" crossorigin="anonymous">
    
    <div id="success-modal" class="fixed inset-0 z-[100] bg-green-600 hidden flex-col items-center justify-center text-black">
        <i class="fas fa-check-circle text-7xl mb-6 animate-bounce text-white drop-shadow-lg"></i>
        <h1 class="mil-font text-4xl md:text-6xl text-white">AUTHORIZED</h1>
        <p class="font-mono text-white/80 mt-2">REDIRECTING PROTOCOL...</p>
    </div>

    <button id="override-btn" class="fixed top-20 right-2 bg-red-900 text-white text-[10px] px-2 py-1 border border-red-500 hidden z-[60] opacity-80" onclick="forceSuccess()">
        (!) OVERRIDE
    </button>

    <script>
        // Configuration
        const REDIRECT_URL = "https://youtube.com/@hesavagowtham";
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        // DOM Elements
        const els = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            faceHud: document.getElementById('face-hud'),
            fingerHud: document.getElementById('finger-hud'),
            console: document.getElementById('console'),
            refImg: document.getElementById('ref-img'),
            btnFace: document.getElementById('btn-face'),
            btnFinger: document.getElementById('btn-finger'),
            matchScore: document.getElementById('match-score'),
            fingerGuide: document.getElementById('finger-guide'),
            fingerBar: document.getElementById('finger-bar'),
            overrideBtn: document.getElementById('override-btn')
        };

        let state = {
            stream: null,
            matcher: null,
            scanning: false
        };

        // --- Utilities ---
        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            if(type === 'err') div.className = "text-red-500 font-bold";
            if(type === 'ok') div.className = "text-green-400 font-bold";
            els.console.prepend(div);
        }

        function speak(msg) {
            if('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(msg);
                u.pitch = 0.8; u.rate = 1.2;
                speechSynthesis.speak(u);
            }
        }

        // --- Init ---
        window.onload = async () => {
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);
            
            log("System Booting...");
            speak("System Online.");

            // Fail-safe timer
            setTimeout(() => {
                if(!state.matcher) {
                    log("AI Timeout. Override Ready.", 'err');
                    els.overrideBtn.classList.remove('hidden');
                }
            }, 12000);

            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                
                log("Neural Nets Active.", 'ok');
                processReference();
            } catch(e) {
                log("AI Load Failed. Check Network.", 'err');
            }
        };

        async function processReference() {
            if(els.refImg.complete && els.refImg.naturalWidth > 0) {
                const detection = await faceapi.detectSingleFace(els.refImg, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptor();
                if(detection) {
                    state.matcher = new faceapi.FaceMatcher(detection, 0.6);
                    log("Target ID Locked.", 'ok');
                    speak("Identity Database Locked.");
                    els.btnFace.disabled = false;
                    els.btnFinger.disabled = false;
                    els.btnFace.classList.add('text-white', 'border-gray-500');
                    els.btnFinger.classList.add('text-white', 'border-gray-500');
                } else {
                    log("Ref Photo Invalid.", 'err');
                }
            } else {
                els.refImg.onload = processReference;
            }
        }

        // --- Camera Engine ---
        async function startCam(mode) {
            if(state.stream) stopCam();
            
            // Responsive constraints
            const constraints = {
                video: {
                    facingMode: mode === 'finger' ? 'environment' : 'user',
                    // We don't set exact width/height to allow browser to optimize for viewport
                }
            };

            try {
                state.stream = await navigator.mediaDevices.getUserMedia(constraints);
                els.video.srcObject = state.stream;
                
                if(mode === 'finger') {
                    const track = state.stream.getVideoTracks()[0];
                    try { await track.applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}
                }

                return new Promise(resolve => {
                    els.video.onloadedmetadata = () => {
                        els.video.play();
                        resolve(true);
                    };
                });
            } catch(e) {
                log("Camera Denied.", 'err');
                speak("Camera access denied.");
                return false;
            }
        }

        function stopCam() {
            if(state.stream) state.stream.getTracks().forEach(t => t.stop());
            state.stream = null;
            state.scanning = false;
            els.faceHud.classList.add('hidden');
            els.fingerHud.classList.add('hidden');
            els.btnFace.classList.remove('active');
            els.btnFinger.classList.remove('active');
        }

        // --- FACE Logic ---
        els.btnFace.onclick = async () => {
            els.btnFace.classList.add('active');
            els.faceHud.classList.remove('hidden');
            els.fingerHud.classList.add('hidden');
            log("Initializing Face Scan...");
            
            if(await startCam('face')) {
                state.scanning = true;
                const displaySize = { width: els.video.videoWidth, height: els.video.videoHeight };
                faceapi.matchDimensions(els.canvas, displaySize);

                // Handle dynamic resize
                els.canvas.style.width = '100%'; els.canvas.style.height = '100%';

                const loop = setInterval(async () => {
                    if(!state.scanning) { clearInterval(loop); return; }

                    const detections = await faceapi.detectAllFaces(els.video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true).withFaceDescriptors();
                    // Essential: resize detections to match CURRENT video display size, not just original resolution
                    const dims = faceapi.matchDimensions(els.canvas, { width: els.video.clientWidth, height: els.video.clientHeight });
                    const resized = faceapi.resizeResults(detections, dims);
                    
                    const ctx = els.canvas.getContext('2d');
                    ctx.clearRect(0,0, els.canvas.width, els.canvas.height);

                    if(resized.length > 0) {
                        const match = state.matcher.findBestMatch(resized[0].descriptor);
                        const score = Math.round((1 - match.distance) * 100);
                        els.matchScore.innerText = score + "%";
                        
                        const box = resized[0].detection.box;
                        const isMatch = match.distance < 0.55;
                        
                        new faceapi.draw.DrawBox(box, { 
                            label: isMatch ? "VERIFIED" : "UNKNOWN", 
                            boxColor: isMatch ? "#00ff41" : "#ff0033" 
                        }).draw(els.canvas);

                        if(isMatch) {
                            clearInterval(loop);
                            success();
                        }
                    }
                }, 100);
            }
        };

        // --- FINGER Logic ---
        els.btnFinger.onclick = async () => {
            els.btnFinger.classList.add('active');
            els.fingerHud.classList.remove('hidden');
            els.faceHud.classList.add('hidden');
            log("Sensor Array Active.");
            
            if(await startCam('finger')) {
                state.scanning = true;
                let progress = 0;
                const cvs = document.createElement('canvas');
                const ctx = cvs.getContext('2d');

                const loop = setInterval(() => {
                    if(!state.scanning) { clearInterval(loop); return; }
                    
                    // Read center pixels
                    cvs.width = 30; cvs.height = 30;
                    ctx.drawImage(els.video, els.video.videoWidth/2 - 15, els.video.videoHeight/2 - 15, 30, 30, 0, 0, 30, 30);
                    const data = ctx.getImageData(0,0,30,30).data;
                    
                    let r=0, g=0, b=0;
                    for(let i=0; i<data.length; i+=4) { r+=data[i]; g+=data[i+1]; b+=data[i+2]; }
                    r /= (data.length/4); g /= (data.length/4); b /= (data.length/4);

                    // Logic: Dark (covered) OR Red (covered+flash)
                    const covered = (r<35 && g<35 && b<35) || (r>70 && g<40 && b<40);
                    
                    if(covered) {
                        progress += 3;
                        els.fingerGuide.classList.add('active');
                    } else {
                        progress = Math.max(0, progress-1);
                        els.fingerGuide.classList.remove('active');
                    }

                    els.fingerBar.style.width = Math.min(100, progress) + "%";
                    
                    if(progress >= 100) {
                        clearInterval(loop);
                        success();
                    }
                }, 50);
            }
        };

        function success() {
            stopCam();
            speak("Access Granted.");
            document.getElementById('success-modal').style.display = 'flex';
            if(navigator.vibrate) navigator.vibrate([200,100,200]);
            setTimeout(() => window.location.href = REDIRECT_URL, 2000);
        }

        window.forceSuccess = success;

    </script>
</body>
</html>